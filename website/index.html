<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="description"    content="Data Visualization"/>
    <meta name="keywords"       content="HTML, CSS, D3"/>
    <meta name="author"         content=""/>
    <title>Assignment</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <style>

    </style>
</head>
<body>
    <p id="globe">
        <p id="sliderValue">XXXX</p>
        <input type="range", class="slider", id="yearSlider">
        <br/>
        <svg id="globesvg"></svg>
        <script>
            // setup variables
            var w = 990;
            var h = 675;
            var dataset;
            var selectedYear;
            var colourRange;
            var values = [];
            var svg = d3.select("#globesvg")
                    .attr("width", w)
                    .attr("height", h)
                    .attr("fill", "grey")
                    .attr("style", "background-color:LightSkyBlue");;
            var projection = d3.geoMercator()
                .center([0, 0])
                .translate([w/2, (h/3)*2])
                .scale(150);
            var path = d3.geoPath()
                .projection(projection);
            // #########
            // FUNCTIONS
            // #########
            // gets the data and returns in the form of a promise
            function GetData() {
                result = d3.csv("Data/DS_Tobacco.csv").then(function(d) {
                    dataset = d;
                    return dataset;
                });
                // returns promise, use .then to access
                return result;
            };
            // DateChanged function
            // called when the date is changed
            function DateChanged() {
                console.log("changed date");
                GetData().then(function(data){
                    d3.json("globe.geo.json").then(function(json) {
                        // clear values
                        values = [];
                        // for data elements
                        for (var i = 0; i < data.length; i++) {
                            // get needed values from data
                            dataRef = data[i].ReferenceArea;
                            dataDate = parseInt(data[i].TIME_PERIOD);
                            dataVal = parseInt(data[i].OBS_VALUE);
                            // check if a valid year is entered
                            if (dataDate <= selectedYear) {
                                // loop through geoJSON
                                for (var j = 0; j < json.features.length; j++) {
                                    // get reference area from json
                                    jsonRef = json.features[j].properties.name_long;
                                    if (dataRef == jsonRef)
                                    {
                                        if (values[j] == undefined)
                                        {
                                            values[j] = [dataVal, dataDate, dataRef];
                                        }
                                        else
                                        {
                                            if (dataDate > values[j][1])
                                            {
                                                values[j] = [dataVal, dataDate, dataRef];
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        // apply json
                        update(json);
                    });
                })
            };
            // Load() function
            // run once on initial start
            function Load() {
                console.log("start Load");
                GetData().then(function(data){
                    var dataMaxTime = d3.max(data, function(d){return d.TIME_PERIOD});
                    var dataMinTime = d3.min(data, function(d){return d.TIME_PERIOD});
                    var dataMaxVal = d3.max(data, function(d){return parseInt(d.OBS_VALUE)});
                    // set min and max of scale
                    d3.select("#yearSlider")
                        .attr("max", dataMaxTime)
                        .attr("min", dataMinTime)
                        .on("input", function(d)
                        {
                            selectedYear = this.value;
                            d3.select("#sliderValue").text(selectedYear);
                            DateChanged();
                        });
                    // set initial value of selected year
                    selectedYear = d3.select("#yearSlider").attr("min");
                    d3.select("#sliderValue").text(selectedYear);
                    // initialize colour range
                    //colourRange = d3.scaleQuantize()
                    colourRange = d3.scaleSequential()
                        .domain([0, dataMaxVal])
                        .interpolator(d3.interpolateReds);
                    makeKey(dataMaxVal);
                    // load json
                    d3.json("globe.geo.json").then(function(json) {
                        // clear values
                        values = [];
                        // for data elements
                        for (var i = 0; i < data.length; i++) {
                            // get needed values from data
                            dataRef = data[i].ReferenceArea;
                            dataDate = parseInt(data[i].TIME_PERIOD);
                            dataVal = parseInt(data[i].OBS_VALUE);
                            // check if a valid year is entered
                            if (dataDate <= selectedYear) {
                                // loop through geoJSON
                                for (var j = 0; j < json.features.length; j++) {
                                    // get reference area from json
                                    jsonRef = json.features[j].properties.name_long;
                                    if (dataRef == jsonRef)
                                    {
                                        if (values[j] == undefined)
                                        {
                                            values[j] = [dataVal, dataDate, dataRef];
                                        }
                                        else
                                        {
                                            if (dataDate > values[j][1])
                                            {
                                                values[j] = [dataVal, dataDate, dataRef];
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        // apply json
                        update(json);
                    });
                })
            }
            function makeKey(dataMaxVal) {
                svg.append('rect')
                        .attr('x', 50)
                        .attr('y', h - 40)
                        .attr('width', 20)
                        .attr('height', 20)
                        .style('fill', colourRange(0));
                    svg.append('rect')
                        .attr('x', 70)
                        .attr('y', h - 40)
                        .attr('width', 20)
                        .attr('height', 20)
                        .style('fill', colourRange(dataMaxVal / 4));
                    svg.append('rect')
                        .attr('x', 90)
                        .attr('y', h - 40)
                        .attr('width', 20)
                        .attr('height', 20)
                        .style('fill', colourRange(dataMaxVal / 4 * 2));
                    svg.append('rect')
                        .attr('x', 110)
                        .attr('y', h - 40)
                        .attr('width', 20)
                        .attr('height', 20)
                        .style('fill', colourRange(dataMaxVal / 4 * 3));
                    svg.append('rect')
                        .attr('x', 130)
                        .attr('y', h - 40)
                        .attr('width', 20)
                        .attr('height', 20)
                        .style('fill', colourRange(dataMaxVal));
            }
            // country clicked function
            // will pas the index and reference of selected countries to another more easier
            //      workable variable
            function countryClicked(countryRef) {
                console.log(countryRef);
            }
            // update function
            // pass in geoJSON, must be called inside of d3.json
            function update(json) {
                svg.selectAll("path")
                    .data(json.features)
                    .join( function(enter) {
                        return enter.append("path")
                            .attr("d", path)
                            .style("fill", function(d,i) {
                                if (values[i])
                                {
                                    index = i
                                    var value = values[i][0]
                                    var reference = values[i][2]
                                    d3.select(this).attr("id", function(){return reference;});
                                    if (value) {
                                        return colourRange(value);
                                    } 
                                    else
                                    {
                                        return "#ccc";
                                    }
                                }
                            })
                            .on("click", function() {
                                countryClicked(d3.select(this).attr("id"));
                            })
                        },
                        function(update) {
                            return update.style("fill", function(d, i) {
                                if (values[i])
                                {
                                    var value = values[i][0]
                                    var reference = values[i][2]
                                    d3.select(this).attr("id", function(){return reference;});
                                    if (value) {
                                        return colourRange(value);
                                    } 
                                    else
                                    {
                                        return "#ccc";
                                    }
                                }
                            })
                            .on("click", function() {
                                countryClicked(d3.select(this).attr("id"));
                            })
                        }
                    ) 
                };
            // call load function
            Load()
        </script>
    </p>
    <br/>
    <br/>
    <footer style="color:grey"><br/>COS30045 Data Visualization<br/></footer>
</body>
</html>