<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="description"    content="Data Visualization"/>
    <meta name="keywords"       content="HTML, CSS, D3"/>
    <meta name="author"         content=""/>
    <title>Assignment</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script stc="https://d3js.org/d3-selection.v1.min.js"></script>
    <style>

    </style>
</head>
<body>
    <p id="globe">
        <div id="choroplethTools">
            <p id="sliderValue" style="display: inline;">XXXX</p>
            <input type="range", class="slider" id="yearSlider" style="display: inline;">
        </div>
        <div id="choropleth">
            <svg id="globesvg" style="display: inline-block;"></svg>
            <ul id="selectedCountries" style="display: inline-block; vertical-align: top;">
                Selected Countries: 
                <li style="list-style-type: none;"><button id="ClearSelection">Clear Selection</button></li>
                <li style="list-style-type: none;"><br/></li>
            </ul>
        </div>
        <script>
            // setup variables
            var w = 990;
            var h = 700;
            var dataset;
            var selectedYear;
            var colourRange;
            var values = [];
            var selectedCountries = [];
            var svg = d3.select("#globesvg")
                    .attr("width", w)
                    .attr("height", h)
                    .attr("fill", "grey")
                    .attr("style", "background-color:LightSkyBlue");;
            var projection = d3.geoMercator()
                .center([0, 0])
                .translate([w/2, (h/3)*2 - 25])
                .scale(150);
            var path = d3.geoPath()
                .projection(projection);
            // #########
            // FUNCTIONS
            // #########
            // gets the data and returns in the form of a promise
            // returning the promise means .then can be used
            function GetData() {
                result = d3.csv("Data/DS_Tobacco.csv").then(function(d) {
                    dataset = d;
                    return dataset;
                });
                // returns promise, use .then to access
                return result;
            };
            // DateChanged function
            // called when the date is changed
            function DateChanged() {
                console.log("changed date");
                GetData().then(function(data){
                    d3.json("globe.geo.json").then(function(json) {
                        // clear values
                        values = [];
                        // for data elements
                        for (var i = 0; i < data.length; i++) {
                            // get needed values from data
                            dataRef = data[i].ReferenceArea;
                            dataDate = parseInt(data[i].TIME_PERIOD);
                            dataVal = parseInt(data[i].OBS_VALUE);
                            // check if a valid year is entered
                            if (dataDate <= selectedYear) {
                                // loop through geoJSON
                                for (var j = 0; j < json.features.length; j++) {
                                    // get reference area from json
                                    jsonRef = json.features[j].properties.name_long;
                                    if (dataRef == jsonRef)
                                    {
                                        if (values[j] == undefined)
                                        {
                                            values[j] = [dataVal, dataDate, dataRef];
                                        }
                                        else
                                        {
                                            if (dataDate > values[j][1])
                                            {
                                                values[j] = [dataVal, dataDate, dataRef];
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        // apply json
                        update(json);
                    });
                })
            };
            // Load() function
            // run once on initial start
            function Load() {
                console.log("start Load");
                GetData().then(function(data){
                    var dataMaxTime = d3.max(data, function(d){return d.TIME_PERIOD});
                    var dataMinTime = d3.min(data, function(d){return d.TIME_PERIOD});
                    var dataMaxVal = d3.max(data, function(d){return parseInt(d.OBS_VALUE)});
                    // setup clear selection button
                    d3.select("#ClearSelection")
                        .on("click", function() {
                            selectedCountries = []
                            d3.selectAll("#selected")
                                .remove()
                        });
                    // set min and max of scale
                    d3.select("#yearSlider")
                        .attr("max", dataMaxTime)
                        .attr("min", dataMinTime)
                        .on("input", function(d)
                        {
                            selectedYear = this.value;
                            d3.select("#sliderValue").text(selectedYear);
                            DateChanged();
                        });
                    // set initial value of selected year
                    selectedYear = d3.select("#yearSlider").attr("min");
                    d3.select("#sliderValue").text(selectedYear);
                    // initialize colour range
                    //colourRange = d3.scaleQuantize()
                    colourRange = d3.scaleSequential()
                        .domain([0, dataMaxVal])
                        .interpolator(d3.interpolateReds);
                    makeKey(dataMaxVal);
                    // load json
                    d3.json("globe.geo.json").then(function(json) {
                        // clear values
                        values = [];
                        // for data elements
                        for (var i = 0; i < data.length; i++) {
                            // get needed values from data
                            dataRef = data[i].ReferenceArea;
                            dataDate = parseInt(data[i].TIME_PERIOD);
                            dataVal = parseInt(data[i].OBS_VALUE);
                            // check if a valid year is entered
                            if (dataDate <= selectedYear) {
                                // loop through geoJSON
                                for (var j = 0; j < json.features.length; j++) {
                                    // get reference area from json
                                    jsonRef = json.features[j].properties.name_long;
                                    if (dataRef == jsonRef)
                                    {
                                        if (values[j] == undefined)
                                        {
                                            values[j] = [dataVal, dataDate, dataRef];
                                        }
                                        else
                                        {
                                            if (dataDate > values[j][1])
                                            {
                                                values[j] = [dataVal, dataDate, dataRef];
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        // apply json
                        update(json);
                    });
                })
            }
            function makeKey(dataMaxVal) {
                svg.append('rect')
                    .attr('x', 30)
                    .attr('y', h - 80)
                    .attr('width', 300)
                    .attr('height', 75)
                    .style('fill', 'silver')
                svg.append('text')
                    .text('percentage of population who smoke daily')
                    .attr('x', 40)
                    .attr('y', h - 60)
                    .style('fill', 'black')
                svg.append('text')
                    .text('0 %')
                    .attr('x', 45)
                    .attr('y', h - 40)
                    .style('fill', 'black')
                svg.append('rect')
                    .attr('x', 75)
                    .attr('y', h - 55)
                    .attr('width', 20)
                    .attr('height', 20)
                    .style('fill', colourRange(0));
                svg.append('rect')
                    .attr('x', 95)
                    .attr('y', h - 55)
                    .attr('width', 20)
                    .attr('height', 20)
                    .style('fill', colourRange(dataMaxVal / 4));
                svg.append('rect')
                    .attr('x', 115)
                    .attr('y', h - 55)
                    .attr('width', 20)
                    .attr('height', 20)
                    .style('fill', colourRange(dataMaxVal / 4 * 2));
                svg.append('rect')
                    .attr('x', 135)
                    .attr('y', h - 55)
                    .attr('width', 20)
                    .attr('height', 20)
                    .style('fill', colourRange(dataMaxVal / 4 * 3));
                svg.append('rect')
                    .attr('x', 155)
                    .attr('y', h - 55)
                    .attr('width', 20)
                    .attr('height', 20)
                    .style('fill', colourRange(dataMaxVal));
                svg.append('text')
                    .text(dataMaxVal + ' %')
                    .attr('x', 180)
                    .attr('y', h - 40)
                    .style('fill', 'black')
                svg.append('rect')
                    .attr('x', 75)
                    .attr('y', h - 35)
                    .attr('width', 20)
                    .attr('height', 20)
                    .style('fill', 'gray')
                svg.append('text')
                    .text('no data avaliable')
                    .attr('x', 100)
                    .attr('y', h - 20)
                    .style('fill', 'black')
            }
            // country clicked function
            // will pas the index and reference of selected countries to another more easier
            //      workable variable
            function countryClicked(countryRef) {
                if (! selectedCountries.includes(countryRef)) {
                    console.log("country clicked")
                    selectedCountries.push(countryRef)
                }
                d3.selectAll("#selected")
                    .remove()
                selectedCountries.forEach(function(item) {
                    d3.select("#selectedCountries")
                        .append("li")
                        .text(item)
                        .attr("id", "selected")
                });
            }
            // update function
            // pass in geoJSON, must be called inside of d3.json
            function update(json) {
                svg.selectAll("path")
                    .data(json.features)
                    .join( function(enter) {
                        return enter.append("path")
                            .attr("d", path)
                            .style("fill", function(d,i) {
                                if (values[i])
                                {
                                    index = i
                                    var value = values[i][0]
                                    var reference = values[i][2]
                                    d3.select(this).attr("id", function(){return reference;});
                                    d3.select(this).attr("dataVal", function(){return value;});
                                    if (value) {
                                        return colourRange(value);
                                    } 
                                    else
                                    {
                                        return "#ccc";
                                    }
                                }
                            })
                            .on("click", function() {
                                countryClicked(d3.select(this).attr("id"));
                            })
                            .on("mouseover", function(d, i) {
                                if (d3.select(this).attr('id'))
                                {
                                    // apply fade
                                    d3.select(this).transition()
                                        .duration(50)
                                        .attr('opacity', '0.75');
                                    // hovering text
                                    var mousepos = d3.pointer(event); 
                                    svg.append('text')
                                        .text(d3.select(this).attr('id'))
                                        .attr('id', 'hovercountry')
                                        .style('fill', 'black')
                                        .attr('x', mousepos[0] + 10)
                                        .attr('y', mousepos[1] - 10);
                                    svg.append('text')
                                        .text(d3.select(this).attr('dataVal') + ' %')
                                        .attr('id', 'hoverval')
                                        .style('fill', 'black')
                                        .attr('x', mousepos[0] + 10)
                                        .attr('y', mousepos[1] + 10);
                                }
                            })
                            .on("mouseout", function(d, i) {
                                if (d3.select(this).attr('id'))
                                {
                                    // remove the fade
                                    d3.select(this).transition()
                                        .duration(50)
                                        .attr('opacity', '1');
                                    // remove hovering text
                                    d3.select('#hovercountry')
                                        .remove();
                                    d3.select('#hoverval')
                                        .remove();
                                }
                            });
                        },
                        function(update) {
                            return update.style("fill", function(d, i) {
                                if (values[i])
                                {
                                    var value = values[i][0]
                                    var reference = values[i][2]
                                    d3.select(this).attr("id", function(){return reference;});
                                    d3.select(this).attr("dataVal", function(){return value;});
                                    if (value) {
                                        return colourRange(value);
                                    } 
                                    else
                                    {
                                        return "#ccc";
                                    }
                                }
                            })
                            .on("click", function() {
                                countryClicked(d3.select(this).attr("id"));
                            })
                            .on("mouseover", function(d, i) {
                                if (d3.select(this).attr('id'))
                                {
                                    // apply fade
                                    d3.select(this).transition()
                                        .duration(50)
                                        .attr('opacity', '0.75');
                                    // hovering text
                                    var mousepos = d3.pointer(event); 
                                    svg.append('text')
                                        .text(d3.select(this).attr('id'))
                                        .attr('id', 'hovercountry')
                                        .style('fill', 'black')
                                        .attr('x', mousepos[0] + 10)
                                        .attr('y', mousepos[1] - 10);
                                    svg.append('text')
                                        .text(d3.select(this).attr('dataVal') + ' %')
                                        .attr('id', 'hoverval')
                                        .style('fill', 'black')
                                        .attr('x', mousepos[0] + 10)
                                        .attr('y', mousepos[1] + 10);
                                }
                            })
                            .on("mouseout", function(d, i) {
                                if (d3.select(this).attr('id'))
                                {
                                    // remove the fade
                                    d3.select(this).transition()
                                        .duration(50)
                                        .attr('opacity', '1');
                                    // remove hovering text
                                    d3.select('#hovercountry')
                                        .remove();
                                    d3.select('#hoverval')
                                        .remove();
                                }
                            });
                        }
                    ) 
                };
            // call load function
            Load()
        </script>
    </p>
    <br/>
    <br/>
    <footer style="color:white ; background-color: gray;">
        <br/>
        Domenic Marulli - 103609316<br/>
        Hritik Anand - 104185477<br/>
        COS30045 Data Visualization - Data Visualization Project Website<br/>
        <br/>
    </footer>
</body>
</html>